<!DOCTYPE html>
<html>
<head>
    <title>rallyd3dependencytree</title>

    <script type="text/javascript" src="/apps/2.0rc1/sdk.js"></script>
    <script type="text/javascript" src="https://boiling-savannah-4452.herokuapp.com/lib/d3.min.js"></script>
    <script type="text/javascript" src="https://boiling-savannah-4452.herokuapp.com/lib/moment.min.js"></script>
    <script type="text/javascript" src="https://boiling-savannah-4452.herokuapp.com/lib/async.js"></script>
    <script type="text/javascript" src="https://boiling-savannah-4452.herokuapp.com/lib/dagre.min.js"></script>
    <script type="text/javascript" src="https://boiling-savannah-4452.herokuapp.com/lib/dagre-d3.min.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                var app=null;Ext.define("CustomApp",{extend:"Rally.app.App",componentCls:"app",maxHeight:5,items:[{xtype:"container",itemId:"10"}],launch:function(){app=this,app.hideAccepted=1==app.getSetting("hideAccepted"),console.log("hideAccepted",app.hideAccepted),app.container_id=this.down("container").id,app.myMask=new Ext.LoadMask(Ext.getBody(),{msg:"Please wait..."}),app.myMask.show(),async.waterfall([this.getDependencySnapshots,this.findMissingSnapshots,this.getProjectInformation,this.getIterationInformation,this._createGraph,this._createNodeList,this._createNodeStatus,this._createDagreGraph],function(err,results){app.myMask.hide(),console.log("results",results)})},config:{defaultSettings:{hideAccepted:!0}},getSettingsFields:function(){return[{name:"hideAccepted",xtype:"rallycheckboxfield",label:"True to hide accepted stories"}]},getProjectInformation:function(snapshots,callback){var projects=_.compact(_.uniq(_.map(snapshots,function(s){return s.get("Project")})));async.map(projects,app.readProject,function(err,results){app.projects=_.compact(_.map(results,function(r){return r[0]})),console.log("projects",app.projects),console.log("closed projects:",_.filter(app.projects,function(p){return"Closed"===p.get("State")})),callback(null,snapshots)})},cleanUpSnapshots:function(snapshots,callback){var snapshots=_.filter(snapshots,function(snapshot){var project=_.find(app.projects,function(p){return snapshot.get("Project")===p.get("ObjectID")});return!(_.isUndefined(project)||_.isNull(project))});console.log("filtered snapshots:",snapshots.length),callback(null,snapshots)},getIterationInformation:function(snapshots,callback){var iterations=_.uniq(_.map(snapshots,function(s){return s.get("Iteration")}));console.log("iterations",iterations);var readIteration=function(iid,callback){var config={model:"Iteration",fetch:["Name","ObjectID","StartDate","EndDate"],filters:[{property:"ObjectID",operator:"=",value:iid}],context:{project:null}};app.wsapiQuery(config,callback)};async.map(iterations,readIteration,function(err,results){app.iterations=_.map(results,function(r){return r[0]}),app.iterations=_.reject(app.iterations,function(i){return""==i||_.isUndefined(i)}),console.log("iterations",app.iterations),callback(null,snapshots)})},readProject:function(pid,callback){var config={model:"Project",fetch:["Name","ObjectID","State"],filters:[{property:"ObjectID",operator:"=",value:pid}]};app.wsapiQuery(config,callback)},wsapiQuery:function(config,callback){var storeConfig={autoLoad:!0,limit:"Infinity",model:config.model,fetch:config.fetch,filters:config.filters,listeners:{scope:this,load:function(store,data){callback(null,data)}}};_.isUndefined(config.context)||(storeConfig.context=config.context),Ext.create("Rally.data.WsapiDataStore",storeConfig)},getMissingSnapshots:function(snapshots){var all=_.pluck(snapshots,function(s){return s.get("ObjectID")}),missing=[];return _.each(snapshots,function(s){var pr=s.get("Predecessors"),su=s.get("Successors");_.isArray(pr)&&missing.push(_.difference(pr,all)),_.isArray(su)}),_.uniq(_.flatten(missing))},findMissingSnapshots:function(snapshots,callback){var missing=app.getMissingSnapshots(snapshots);console.log("missing:",missing);var config={};config.fetch=["ObjectID","_UnformattedID","_TypeHierarchy","Predecessors","Successors","Blocked","ScheduleState","Name","Project","Iteration","FormattedID"],config.hydrate=["_TypeHierarchy","ScheduleState"],config.find={ObjectID:{$in:missing},__At:"current"},async.map([config],app._snapshotQuery,function(err,results){console.log("missing snapshots:",results[0]),_.each(results[0],function(s){snapshots.push(s)}),app.getMissingSnapshots(snapshots).length>0?app.findMissingSnapshots(snapshots,callback):callback(null,snapshots)})},getDependencySnapshots:function(callback){var that=this,config={};config.fetch=["ObjectID","_UnformattedID","_TypeHierarchy","Predecessors","Successors","Blocked","ScheduleState","Name","Project","Iteration","FormattedID"],config.hydrate=["_TypeHierarchy","ScheduleState"],config.find={_TypeHierarchy:{$in:["HierarchicalRequirement"]},_ProjectHierarchy:{$in:app.getContext().getProject().ObjectID},__At:"current",$or:[{Predecessors:{$exists:!0}}]},app.hideAccepted&&(config.find.ScheduleState={$ne:"Accepted"}),async.map([config],app._snapshotQuery,function(error,results){callback(null,results[0])})},_snapshotQuery:function(config,callback){var storeConfig={find:config.find,fetch:config.fetch,hydrate:config.hydrate,autoLoad:!0,pageSize:1e4,limit:"Infinity",listeners:{scope:this,load:function(store,snapshots,success){console.log("snapshots:",snapshots.length),callback(null,snapshots)}}},snapshotStore=Ext.create("Rally.data.lookback.SnapshotStore",storeConfig)},_renderNodeLabel:function(node){var project=_.find(app.projects,function(p){return node.snapshot.get("Project")===p.get("ObjectID")});(_.isUndefined(project)||_.isNull(project))&&console.log("problem with project for:",node);var iterationEndDate=app._iterationEndDate(node.snapshot.get("Iteration")),date_span="",date_style=null;iterationEndDate&&node.status.length>0&&(date_style=node.status[0].status),date_span="<span class='"+date_style+"'>"+(iterationEndDate?moment(iterationEndDate).format("MM/DD/YYYY"):"")+"</span>";var idstyle="";"Accepted"===node.snapshot.get("ScheduleState")&&(idstyle="accepted-story");var state_class=node.snapshot.get("Blocked")===!0?"status-blocked":"",state_span="<span class='"+state_class+"'>"+" ["+node.snapshot.get("ScheduleState").substring(0,1)+"] ";return"<table class='graph-node'><tr><td><span class='story-name'><span class="+idstyle+">"+node.snapshot.get("FormattedID")+"</span>"+":"+node.snapshot.get("Name")+state_span+"</span>"+"</td></tr>"+"<tr><td>"+"Project:"+(_.isUndefined(project)||_.isNull(project)?"Closed":project.get("Name"))+"</td></tr>"+"<tr><td>"+date_span+"</td></tr>"+"</tr></table>"},_createDagreGraph:function(nodes,links,callback){var g=new dagre.Digraph;_.each(nodes,function(node){g.addNode(node.id,{label:app._renderNodeLabel(node)})}),_.each(links,function(link){g.addEdge(null,link.source.id,link.target.id,{label:""})});var width=32e3,height=32e3,svg=d3.select("body").append("div").attr("class","div-container").append("svg").attr("class","svg").attr("width",width).attr("height",height).append("g").attr("transform","translate(20,20)"),renderer=new dagreD3.Renderer;renderer.run(g,d3.select("svg g")),callback(null,nodes,links)},_createGraph:function(snapshots,callback){var that=this,p=_.filter(snapshots,function(rec){return _.isArray(rec.get("Predecessors"))}),s=_.filter(snapshots,function(rec){return _.isArray(rec.get("Successors"))}),nodes=_.map(snapshots,function(snap){return _.isArray(snap.get("Predecessors"))||_.isArray(snap.get("Successors"))?{id:snap.get("ObjectID"),snapshot:snap}:null});nodes=_.compact(nodes);var links=[];_.each(nodes,function(node){_.each(node.snapshot.get("Predecessors"),function(pred){var target=_.find(nodes,function(node){return node.id==pred});_.isUndefined(target)?console.log("unable to find pred:",pred):links.push({source:node,target:target})})}),callback(null,nodes,links)},_createLinkListForNode:function(node,list,nodes,links){list.push(node);var nodeLinks=_.filter(links,function(link){return link.source.id===node.id});_.each(nodeLinks,function(ln){app._createLinkListForNode(ln.target,list,nodes,links)})},_createNodeList:function(nodes,links,callback){_.each(nodes,function(node){var list=[];app._createLinkListForNode(node,list,nodes,links),node.list=list}),callback(null,nodes,links)},_createNodeStatus:function(nodes,links,callback){_.each(nodes,function(node){_.each(node.list,function(listNode,i){if(node.status=[],i>0){var status=app._createStatusForNodes(node,listNode);"status-good"!==status&&node.status.push({status:status,target:listNode})}})}),callback(null,nodes,links)},_getIteration:function(iid){var iteration=_.find(app.iterations,function(it){return iid===it.get("ObjectID")});return iteration},_iterationEndDate:function(iid){var iteration=app._getIteration(iid);return iteration?iteration.raw.EndDate:null},_createStatusForNodes:function(src,tgt){var srcIteration=src.snapshot.get("Iteration"),tgtIteration=tgt.snapshot.get("Iteration");return _.isUndefined(tgtIteration)||_.isNull(tgtIteration)||""===tgtIteration?"status-not-scheduled":!(_.isUndefined(srcIteration)||_.isNull(srcIteration)||_.isUndefined(tgtIteration)||_.isNull(tgtIteration))&&app._iterationEndDate(tgtIteration)>app._iterationEndDate(srcIteration)?"status-bad":"status-good"},_nodeStatusStyle:function(node){var red=_.find(node.status,function(s){return"red"==s.status});if(red)return"red";var yellow=_.find(node.status,function(s){return"yellow"==s.status});return yellow?"yellow":"green"},_linkStatusStyle:function(link){var status=app._createStatusForNodes(link.source,link.target);return status},getProjectColor:function(pid){var i=_.findIndex(app.projects,function(p){return _.isUndefined(p)?!1:pid===p.get("ObjectID")});return app.color(i)},addColorLegend:function(color,w,h){var div=d3.select("body").select("svg").append("svg:g").attr("class","color-legend").attr("transform","translate("+4*(w/5)+",20)"),enter=d3.select("body").select("svg").select(".color-legend").selectAll("g").data(app.projects,function(d,i){return _.isUndefined(d)?"":d.get("ObjectID")}).enter(),divs=enter.append("g");divs.append("svg:circle").attr("r",5).attr("cx",20).attr("cy",function(d,i){return 20*(i+1)}).style("fill",function(d,i){return color(i)}),divs.append("svg:text").attr("x",30).attr("y",function(d,i){return 20*(i+1)+3}).text(function(d,i){return _.isUndefined(d)?"":d.get("Name")})},_forceDirectedGraph:function(nodes,links,callback){var width=1200,height=800;app.color=d3.scale.category20b();var svg=d3.select("body").append("svg").attr("class","svg").attr("width",width).attr("height",height).on("mousemove",app.myMouseMoveFunction),div=d3.select("body").append("div").html("Some text").classed("infobox",!0);app.addColorLegend(app.color,width,height),svg.append("svg:defs").append("svg:marker").attr("id","end-arrow").attr("viewBox","0 -5 10 10").attr("refX",6).attr("markerWidth",5).attr("markerHeight",5).attr("orient","auto").append("svg:path").attr("d","M0,-5L10,0L0,5").attr("fill","#000"),svg.append("svg:defs").append("svg:marker").attr("id","start-arrow").attr("viewBox","0 -5 10 10").attr("refX",4).attr("markerWidth",3).attr("markerHeight",3).attr("orient","auto").append("svg:path").attr("d","M10,-5L0,0L10,5").attr("fill","#000");var force=d3.layout.force().charge(-90).linkDistance(30).size([width,height]).nodes(nodes).links(links).start(),path=svg.append("svg:g").selectAll("path").data(links).enter().append("svg:path").attr("class","link").attr("stroke-dasharray",function(d){var status=app._linkStatusStyle(d);return"red"==status?"2,2":""}).attr("marker-end","url(#end-arrow)"),statusNodes=_.filter(nodes,function(n){return"green"!==app._nodeStatusStyle(n)}),circle=svg.append("svg:g").selectAll("g").data(nodes,function(d){return d.id}).enter().append("svg:g").append("svg:circle").attr("class","node").attr("r",5).style("fill",function(d){return app.getProjectColor(d.snapshot.get("Project"))}).call(force.drag).on("mouseover",app.myMouseOverFunction).on("mouseout",app.myMouseOutFunction).on("click",app.myMouseClick),circle1=svg.append("svg:g").selectAll("g").data(statusNodes,function(d){return d.id}).enter().append("svg:g").append("svg:circle").attr("class","node1").attr("r",2).style("fill",function(d){return app._nodeStatusStyle(d)}).call(force.drag);force.on("tick",function(){path.attr("d",function(d){var deltaX=d.target.x-d.source.x,deltaY=d.target.y-d.source.y,dist=Math.sqrt(deltaX*deltaX+deltaY*deltaY),normX=deltaX/dist,normY=deltaY/dist,sourcePadding=10,targetPadding=10,sourceX=d.source.x+sourcePadding*normX,sourceY=d.source.y+sourcePadding*normY,targetX=d.target.x-targetPadding*normX,targetY=d.target.y-targetPadding*normY;return"M"+sourceX+","+sourceY+"L"+targetX+","+targetY}),circle.attr("transform",function(d){return"translate("+d.x+","+d.y+")"}),circle1.attr("transform",function(d){return"translate("+(d.x-6)+","+(d.y-6)+")"})}),callback(null,nodes,links)},_createStoryDetails:function(node){var s=node.snapshot,box=d3.select(".infobox");box.html(""),box.append("div").attr("class","title").html("S"+s.get("_UnformattedID")+":"+s.get("Name")),_.each(node.list.slice(1),function(d){var ds=d.snapshot,color=app.getProjectColor(ds.get("Project")),iteration=app._getIteration(ds.get("Iteration")),iterationName=iteration?iteration.get("Name"):"",iterationEnd=iteration?iteration.get("EndDate"):"",m=iteration?moment(iterationEnd).format("(MMM DD)"):"",item=box.append("div").attr("class","item").attr("style","color:white;background-color:"+color+";").html("S"+ds.get("_UnformattedID")+":"+ds.get("Name"));item.append("div").attr("style","color:white;background-color:red;").html(ds.get("Blocked")?"Blocked":"");var itStatus=app._createStatusForNodes(node,d),textColor="yellow"===itStatus?"black":"white";console.log("status check:",node.snapshot.get("_UnformattedID"),d,itStatus);var itMessage=iteration?iteration.get("Name")+" "+m:"Unscheduled";item.append("div").html(itMessage).attr("style","color:"+textColor+";background-color:"+itStatus+";")})},myMouseClick:function(d){console.log("click:",d),app._createStoryDetails(d)},myMouseOverFunction:function(d){var circle=d3.select(this);circle.attr("fill","red");var infobox=d3.select(".infobox"),coord=d3.mouse(this);infobox.style("left",coord[0]+15+"px"),infobox.style("top",coord[1]+"px"),infobox.style("display","block"),infobox.html(d.snapshot.get("_UnformattedID")+":"+d.snapshot.get("Name")),d3.select("p").text("This circle has a radius of "+circle.attr("r")+" pixels.")},myMouseOutFunction:function(){},myMouseMoveFunction:function(){}});

            Rally.launchApp('CustomApp', {
                name:"rallyd3dependencytree",
	            parentRepos:""
            });

        });
    </script>


    <style type="text/css">
        .app {
     /* Add app styles here */

}

.div-container {
    width: 1200;
    height: 800;
    overflow: scroll;
}


/*.svg {
    overflow: auto;
}
*/
.graph-node {
  padding : 50px;
  margin: 5px;
  width: 100;
  height: 100;

}

.node rect {
    stroke: #333;
    stroke-width: 1.5px;
    fill: #fff;
}

.edgeLabel rect {
    fill: #fff;
}

.edgePath {
    stroke: #333;
    stroke-width: 1.5px;
    fill: none;
}

.accepted-story {
  color:white;
  background-color:green;
}

.status-not-scheduled  {
  color:black;
  background-color: yellow;
}

.status-good  {
  color:white;
  background-color: green;
}

.status-bad {
  color:white;
  background-color: red;
}

.status-blocked {
  color:red;
}

.story-name {
  float: left;
  width : 175px;
}

/*
.node {
  stroke: #fff;
  stroke-width: 1.5px;
}

.link {
  stroke: #999;
  stroke-opacity: .6;
}

path.link {
  fill: none;
  stroke: #000;
  stroke-width: 1px;
  cursor: default;
}

.infobox {
        margin-top : 20px;
        position: absolute;
        width: 200px;
        padding: 10px;
        background: rgba(242, 242, 242, 0.9);
        -moz-border-radius: 15px;
        border-radius: 15px;
}

.title {
  font-weight:bold;
  text-align : center;

}

.item {
  text-align : left;
  padding:5px;
  -moz-border-radius: 15px;
  margin-top:5px;
}

.type1 {
    width: 10px;
    height: 10px;
    background: yellow;
    border: 3px solid red
}

.circleBase {
    -webkit-border-radius: 999px;
    -moz-border-radius: 999px;
    border-radius: 999px;
    behavior: url(PIE.htc);
}


.svg {
  position: relative;
}
.color-legend {
  float:right;
}*/
    </style>
</head>
<body></body>
</html>
